#!/usr/bin/env node

var sey = require('../src/main.js'),
    path = require('path'),
    commander = require('commander'),
    updateNotifier = require('update-notifier'),
    pkg = require('../package.json'),
    exitCode = 0;

updateNotifier({ pkg: pkg })
    .notify({ defer: false });

commander
    .version(pkg.version)
    .description(pkg.description)
    .command('init', 'initializes a sey file')
    .command('build', 'starts build')
    .command('self-check', 'checks sey\'s self integrity.')
    .option('-f, --file <seyfile.js>', 'loads specified sey file')
    .option('-np, --nopartial', 'disables partial building');

commander.cli = true;
commander.parse(process.argv);

process.on('uncaughtException', function (err) {
    console.error(err.stack);
    exitCode = 1;
});

process.on('exit', function () {
    process.exit(exitCode);
});

// --file option
var seyfile;

if (commander.file === undefined) {
    seyfile = path.join(process.cwd(), 'seyfile.js');
} else {
    if (!path.isAbsolute(commander.file)) {
        seyfile = path.join(process.cwd(), commander.file);
    } else {
        seyfile = commander.file;
    }
}

// command
var command = commander.args.shift() || 'build';

switch (command) {
    case 'init':
        sey.initFile(seyfile);
        break;

    case 'build':
        global.sey = sey;
        var result = require(seyfile);
        break;

    case 'self-check':
        sey.selfCheck();
        break;

    default:
        console.log('unknown command -', command);
        break;
}
